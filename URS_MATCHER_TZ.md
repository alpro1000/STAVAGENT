# ТЗ v1.0 — Web-сервис подбора ÚRS-позиций по výkazu výměr

**Версия:** 1.0
**Дата:** Ноябрь 2025
**Статус:** Готово для разработки (MVP-1)

---

## 1. Цель сервиса

Создать web-сервис, который:

1. Принимает **výkaz výměr / список работ** в виде файла или текста.
2. С помощью **LLM + онлайнового поиска**:

   * подбирает **позиции ÚRS** строго из каталога `https://podminky.urs.cz/home?productId=dPG7rN6DHQNGs5ErQ7IF`;
   * проверяет **технологию выполнения работ** (земляные, бетон, výztuž, prostupy и т.д.);
   * автоматически добавляет **обязательные сопутствующие работы** (výkopy, zásypy, lože, bednění, přesun hmot и др.).
3. Может использовать:

   * **донорные сметы** из интернета как примеры (train/пример для AI);
   * **Perplexity API** для поиска по сайту ÚRS и общему web;
   * **OpenAI / Claude API** как LLM-двигатель.
4. На выходе формирует:

   * таблицу `Kód ÚRS – Popis – MJ – Množství – Zdroj/обоснование`;
   * лог/объяснение, почему выбраны именно эти коды и какие правила были применены.

---

## 2. Основные сценарии (use-cases)

### 2.1. Один файл – одна смета

* Пользователь загружает výkaz (Excel/ODS/XML/CSV).
* Выбирает тип объекта (например: základy, hrubá stavba, komunikace).
* Нажимает «Обработать».
* Сервис возвращает:

  * список подобранных позиций ÚRS для каждой строки;
  * подсказки по **недостающим** работам (например: есть beton desky, но нет bednění / výztuž / přesun hmot).

### 2.2. Ручной ввод одной строки

* Пользователь вводит строку вида:
  `Podkladní beton C25/30 tl. 100 mm pod ZD – 25 m3`.
* Сервис возвращает:

  * 1–3 рекомендуемых кода ÚRS (основная работа);
  * набор сопутствующих работ (bednění, přesun hmot и др., если применимо).

### 2.3. Проверка уже существующей ÚRS-сметы

* Пользователь загружает смету, в которой уже есть коды ÚRS.
* Сервис:

  * проверяет технологическую целостность:

    * есть beton → должны быть bednění, výztuž (если это ŽB) и т.п.;
    * земляные → наличие zásypy, hutnění и т.д.;
  * выявляет возможные лишние/дублирующие позиции;
  * предлагает исправления / дополнения, помечая их как рекомендации.

---

## 3. Входные данные (форматы)

Минимально поддерживаемые типы:

* Таблицы: `.xlsx`, `.xls`, `.ods`.
* XML форматы výkazů (TSKP/ÚRS), если есть спецификация.
* `.csv` и простой текст (строки, разделённые переводом строки).

Для **каждой строки** нужно уметь извлечь:

* **Popis** (описание работы, строка).
* **Množství** (число) и **MJ** (jednotka: m, m2, m3, ks…).
* Дополнительно (если есть): номер позиции, примечание, часть/etáž, konstrukční část и т.д.

Требование: парсер должен быть расширяемым на новые шаблоны таблиц (через конфиг/маппинг заголовков).

---

## 4. Выходной формат

**Единый JSON-ответ**, плюс возможность отдать это как таблицу (для UI / экспорта):

```json
{
  "job_id": "uuid-здесь",
  "status": "completed",
  "items": [
    {
      "input_row_id": 1,
      "input_text": "Podkladní betonová deska C25/30 23,57 m3",
      "urs_code": "801321111",
      "urs_name": "Beton podkladní C 16/20 až C 25/30",
      "unit": "m3",
      "quantity": 23.57,
      "confidence": 0.94,
      "source": {
        "match_type": "ai+search",
        "links": [
          "https://podminky.urs.cz/..."
        ],
        "donor_examples": [
          "https://example.com/nejaka_rozpocet.xlsx"
        ]
      },
      "extra_generated": false
    },
    {
      "input_row_id": 1,
      "urs_code": "801171321",
      "urs_name": "Bednění vodorovných konstrukcí",
      "unit": "m2",
      "quantity": 36.5,
      "confidence": 0.88,
      "source": {
        "reason": "Souprovázející práce k betonáži desky",
        "rule": "tech_rule_bedneni_for_slab"
      },
      "extra_generated": true
    }
  ],
  "warnings": [
    "Pozice 5: nalezeno několik kandidátů ÚRS s podobnou jistotou – nutná kontrola člověkem."
  ],
  "processing_time_ms": 4520
}
```

Требования:

* `extra_generated = false` — позиции, напрямую соответствующие строке výkazu.
* `extra_generated = true` — позиции, добавленные автоматически как технологически необходимые.
* `confidence` в диапазоне 0–1, с понятной логикой порогов (exact ≥0.9, partial 0.6–0.9).

---

## 5. Архитектура (предложение)

### 5.1. Компоненты

#### 1. Backend API

* Язык: **Node.js / Python / Go** — на выбор.
* Фреймворк: Express / FastAPI / Gin.
* REST API.
* Задачи:

  * приём файлов и текстов;
  * распарсивание в унифицированный формат строк;
  * вызов AI-слоя и Perplexity;
  * работа с базой данных (кэш ÚRS, история jobů);
  * выдача JSON-результатов и файлов для экспорта.

#### 2. AI-слой

Обёртки над:

* **OpenAI / Claude**:

  * semantic-search / embeddings (по локальной БД ÚRS);
  * reasoning (выбор лучшего кандидата, объяснение, tech-rules).
* **Perplexity API**:

  * поиск по `podminky.urs.cz` с ограничением домена;
  * общий web-поиск донорных смет (rozpočty, výkazy výměr).

#### 3. Модуль ÚRS-каталога

* Локальная БД / кэш со структурой каталога ÚRS:

  * `urs_code`
  * `urs_name`
  * `unit`
  * текст условий/описания (если возможно).
* Механизм обновления (скрипт, cron, ручной запуск).
* **Важно:** разработчик обязан проверить юридически, как хранить и кэшировать данные ÚRS, чтобы не нарушать лицензию/авторские права.

#### 4. База данных

PostgreSQL / SQLite для MVP:

* `urs_items` — коды и описания ÚRS.
* `jobs` — загруженные výkazy, статус обработки, краткий результат.
* `mapping_examples` — примеры успешных сопоставлений (донорные сметы).
* Лог запросов к LLM/Perplexity (без персональных данных, только технические).

#### 5. Frontend (web-UI)

* Форма загрузки файла.
* Форма ручного ввода строки.
* Таблица с результатами:

  * возможность правки `urs_code`, отметки правильности, удаления/добавления позиций.
* Кнопки экспорта: `.xlsx`, `.csv`, возможно XML-формат для KROS/URS.

---

## 6. Логика обработки (pipeline)

### 6.1. Разбор входного файла

1. Определить тип: Excel/ODS/XML/CSV/текст.
2. Используя маппинг заголовков (CZ/склонения/варианты), выделить:

   * popis,
   * množství,
   * MJ,
   * дополнительные поля (номер, část, poznámka).
3. Сохранить «сырые» строки + нормализованное представление для дальнейшей обработки.

### 6.2. Предварительный подбор ÚRS-кандидатов

Для каждой строки:

1. **Нормализация текста**:

   * удалить чистые числа (оставить ключевые: классы бетона, толщины/ширины);
   * привести к базовым формам слов (лемматизация чешского; можно через external lib или LLM);
   * удалить типовые «шумы» (provedení, kompletní, apod.).
2. Вызвать **semantic search** по `urs_items`:

   * embeddings-поиск (OpenAI embeddings, или иные вектора);
   * или BM25/TF-IDF + LLM-ранжирование.
3. Получить список кандидатов с оценками `confidence`.

### 6.3. Уточнение через Perplexity + сайт ÚRS

Если у строки **нет уверенного кандидата** (например, `confidence_max < 0.8`):

1. Сформировать поисковый запрос вида:
   `"ÚRS položka pro 'Podkladní betonová deska C25/30' site:podminky.urs.cz"`.
2. Вызвать Perplexity API с ограничением домена `podminky.urs.cz`.
3. Из результата вытащить:

   * возможные коды ÚRS,
   * описания/части каталога.
4. Свести вместе:

   * локальных кандидатов,
   * найденные коды с сайта.
5. Передать это в LLM-функцию, которая по строгим правилам выбирает **до N лучших кандидатов, не придумывая новые коды**.

### 6.4. Генерация сопутствующих работ (tech-rules)

Необходим отдельный модуль **технологических правил**, два слоя:

#### Жёсткие правила в коде (JSON/YAML):

Примеры:

* Есть betonová deska → нужны:

  * bednění vodorovných konstrukcí (m2),
  * případně výztuž (если ŽB),
  * přesun hmot до X км (если в смете нет ни одной позиции na přesun).
* Есть ŽB pasy / patky → bednění + výztuž.
* Есть pokládka potrubí v zemi → výkopy, lože, zásyp hutněný.
* Есть prostupy → vytvoření prostupu + vložení chráničky/ potrubí.

#### AI-надстройка:

Передавать список уже подобранных ÚRS-позиций в LLM с инструкцией:

* определить, каких технологически обязательных позиций не хватает;
* подобрать для них коды из каталога;
* вернуть их отдельно с пометкой `extra_generated = true` и ссылкой на `rule`/`reason`.

---

## 7. Интеграция с LLM (OpenAI / Claude)

Внутри backend предусмотреть отдельные функции:

1. `match_urs_item(text, quantity, unit) -> [candidates]`
2. `generate_related_items(list_of_urs_items) -> extra_items`
3. `explain_mapping(input_row, chosen_urs, search_results) -> explanation`

### Требования:

* Каждая функция реализуется как **отдельный prompt** с чёткими правилами:

  * «Ты – сметчик в Чехии, ты выбираешь только коды из переданного списка, не придумываешь новые».
* **Жёстко запрещено** генерировать несуществующие коды ÚRS.
* История запросов между разными пользователями не смешивается.
* Логируются только технические данные (без персональной идентификации).

---

## 8. Интеграция с Perplexity

Разработчик должен:

1. Изучить **Perplexity API** и допустимые режимы использования.
2. Реализовать функцию:

```typescript
async function searchUrsSite(query: string): Promise<SearchResult[]> {
  // query + " site:podminky.urs.cz"
  // Возвращает результаты из каталога ÚRS
}
```

3. Реализовать функцию поиска донорных смет:

```typescript
async function searchDonorBillsOfQuantities(query: string): Promise<string[]> {
  // например: "rozpočet základy ÚRS xlsx filetype:xlsx"
  // Возвращает URL-ы найденных примеров смет
}
```

4. Учитывать:

   * лимиты по запросам, стоимость;
   * robots.txt и ToS сайтов (не ломать).

---

## 9. Нефункциональные требования

* **Языки интерфейса**: минимум CZ, опционально RU/EN.
* **UX ошибок**: понятные сообщения (ошибка загрузки, формат не распознан, превышен лимит, нет уверенного совпадения и т.д.).
* **Прозрачность**:

  * для каждой строки – список рассмотренных кандидатов ÚRS;
  * причина выбора;
  * какие tech-rules применены для сопутствующих работ.
* **Расширяемость**:

  * архитектура должна позволять в будущем подключить другие каталоги (RTS, OTSKP) с тем же API.
* **Безопасность и право**:

  * исходные файлы хранить ограниченное время (конфигурируемо);
  * не нарушать лицензионные условия ÚRS и других сторонних источников;
  * не сохранять лишние персональные данные пользователей.
* **Производительность**:

  * обработка файла на 100–500 строк: <30 сек.
  * обработка текстовой строки: <5 сек.

---

## 10. План по этапам

### Этап 1 — MVP-1 (2–3 недели)

* Загрузка Excel/ODS/CSV.
* Парсер строк (popis, množství, MJ).
* Простое сопоставление строк с ÚRS по локальному каталогу:

  * без Perplexity,
  * без генерации сопутствующих работ.
* Ручной ввод одной строки.
* Вывод базовой таблицы `Kód–Popis–MJ–Množství` (без сложной логики confidence).
* Простой REST API для загрузки и получения результатов.

### Этап 2 — MVP-2 (2–3 недели)

* Добавить OpenAI/Claude для semantic-match и ранжирования кандидатов.
* Ввести `confidence` и пороги.
* Реализовать базовый набор tech-rules и генерацию сопутствующих работ.
* Экспорт результатов в `.xlsx`.

### Этап 3 — MVP-3 (2–3 недели)

* Интеграция с Perplexity:

  * поиск по `podminky.urs.cz`,
  * поиск донорных смет.
* Сохранение примерных маппингов (`mapping_examples`).
* Веб-UI:

  * ручное редактирование кодов;
  * просмотр лога объяснений;
  * отметки «подтверждено сметчиком».

### Этап 4 — Production (4+ недели)

* Очереди задач (очень большие файлы).
* Авторизация и учёт пользователей.
* История обработанных смет, повторная загрузка и сравнение.
* Мониторинг, логирование, алерты.
* Кэширование результатов обработки.

---

## 11. API-endpoints (базовый набор)

| Метод | Endpoint | Описание |
|-------|----------|---------|
| POST | `/api/jobs/file-upload` | Загрузить файл для обработки |
| POST | `/api/jobs/text-match` | Обработать одну текстовую строку |
| GET | `/api/jobs/{jobId}` | Получить результаты обработки |
| POST | `/api/jobs/{jobId}/export` | Экспортировать результаты (xlsx/csv) |
| POST | `/api/jobs/{jobId}/verify` | Пользователь подтверждает/правит результаты |
| GET | `/api/urs-catalog` | Получить список ÚRS-позиций (для фильтра/автодополнения) |

---

## 12. Критерии приёма (Definition of Done)

### MVP-1 COMPLETE когда:

- [ ] Загрузка Excel/ODS/CSV работает без ошибок
- [ ] Парсер корректно выделяет popis, množství, MJ из 5+ тестовых файлов
- [ ] Сопоставление работает для 80%+ позиций локального каталога
- [ ] JSON-ответ соответствует спецификации из раздела 4
- [ ] REST API полностью задокументирован (OpenAPI/Swagger)
- [ ] Покрыто unit-тестами (минимум 60%)
- [ ] README с инструкциями по запуску и использованию

### MVP-2 COMPLETE когда:

- [ ] OpenAI/Claude интегрирован и работает для ранжирования
- [ ] `confidence` вычисляется корректно
- [ ] 5+ tech-rules реализовано и протестировано
- [ ] Экспорт в `.xlsx` работает, файл открывается в Excel/LibreOffice
- [ ] Все API-endpoints работают по spec

### MVP-3 COMPLETE когда:

- [ ] Perplexity интегрирован (тестируется на 10+ запросах к ÚRS)
- [ ] Frontend UI загружается, форма отправки файла работает
- [ ] Таблица результатов редактируется (пользователь может менять коды)
- [ ] История jobs сохраняется в БД и может быть загружена

---

## 13. Файлы для разработчика

### Документация

* `README.md` — запуск и использование
* `API.md` — полная OpenAPI-спецификация
* `ARCHITECTURE.md` — описание модулей и взаимодействие
* `TECH-RULES.md` — описание технологических правил

### Код (структура для Node.js + Express)

```
urs-matcher/
├── backend/
│   ├── src/
│   │   ├── api/
│   │   │   ├── routes/
│   │   │   │   ├── jobs.js
│   │   │   │   ├── urs-catalog.js
│   │   │   │   └── health.js
│   │   │   └── middleware/
│   │   ├── services/
│   │   │   ├── fileParser.js
│   │   │   ├── ursMatcher.js (LLM-функции)
│   │   │   ├── perplexityClient.js
│   │   │   ├── llmClient.js
│   │   │   └── techRules.js
│   │   ├── db/
│   │   │   ├── init.js
│   │   │   ├── migrations/
│   │   │   └── schema.sql
│   │   ├── utils/
│   │   │   ├── logger.js
│   │   │   └── validators.js
│   │   └── app.js
│   ├── tests/
│   │   ├── fileParser.test.js
│   │   ├── ursMatcher.test.js
│   │   └── fixtures/
│   ├── .env.example
│   ├── package.json
│   └── README.md
├── frontend/
│   ├── src/
│   │   ├── pages/
│   │   ├── components/
│   │   └── services/
│   ├── public/
│   └── package.json
├── docs/
│   ├── ARCHITECTURE.md
│   ├── API.md
│   └── TECH-RULES.md
└── docker-compose.yml (для быстрого запуска dev-окружения)
```

---

## 14. Ссылки и ресурсы

* **ÚRS каталог:** https://podminky.urs.cz/
* **OpenAI API:** https://platform.openai.com/docs/
* **Claude API:** https://docs.anthropic.com/
* **Perplexity API:** https://docs.perplexity.ai/
* **Чешский язык, лемматизация:** https://pypi.org/project/czech-stemmer/ или обёртка в LLM

---

**Статус документа:** ГОТОВО К РАЗРАБОТКЕ
**Автор ТЗ:** STAVAGENT Team
**Последний апдейт:** Ноябрь 2025

