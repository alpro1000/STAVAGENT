# URS Matcher Service - Полное описание системы

## 🎯 Что такое система?

**URS Matcher Service** - это интеллектуальная система для матчинга позиций в смете (БОК) с кодами УРС (Единой классификации строительных работ). Система использует AI (Claude) и многоролевую экспертизу для анализа строительных работ.

---

## 📱 Как пользователь взаимодействует с системой

### Сценарий 1: Новый пользователь входит на сайт

```
ДЕЙСТВИЕ ПОЛЬЗОВАТЕЛЯ:
→ Открывает браузер
→ Переходит на http://localhost:3000

РЕАКЦИЯ СИСТЕМЫ:
✅ Загружается главная страница (index.html)
✅ Показывается стартовый экран с 3 основными кнопками:
   1. 📄 Наhrát Soubor (Загрузить файл)
   2. ✏️ Zadat Text (Ввести текст вручную)
   3. 📋 Nahrát Dokumenty (Загрузить документы)

ФРОНТЕНД:
- Три большие кнопки с иконками
- Описание каждой функции
- Цветной градиент фон (фиолетовый-розовый)
```

---

## 🔄 Основной рабочий поток (Фаза 1-3)

### Сценарий 2: Пользователь загружает файл со сметой

```
ДЕЙСТВИЕ ПОЛЬЗОВАТЕЛЯ:
→ Нажимает кнопку "📄 Наhrát Soubor"
→ Выбирает XLSX файл с БОК (сметой)
   Пример файла:
   ┌──────────────────────────────────────┐
   │ Описание работы | Количество | Ед.   │
   ├──────────────────────────────────────┤
   │ Бетон C30/37 укладка     │ 50     │ м3  │
   │ Опалубка деревянная      │ 200    │ м2  │
   │ Арматура А500            │ 10     │ т   │
   └──────────────────────────────────────┘

РЕАКЦИЯ СИСТЕМЫ:
1. 🔄 Показывает индикатор загрузки
2. 📊 Парсит Excel файл:
   - Извлекает описания работ
   - Извлекает количества и единицы
   - Разделяет на БЛОКИ по типам работ (TŘÍDNÍK классификация)
3. 💾 Сохраняет в БД
4. ✅ Показывает результаты

ФРОНТЕНД:
- Прогресс-бар с процентом
- Количество найденных строк
- Список выявленных блоков работ
```

---

### Сценарий 3: Система группирует работы в блоки (TŘÍDNÍK)

```
ВХОДНЫЕ ДАННЫЕ (из файла):
- Бетон C30/37 укладка
- Опалубка деревянная
- Арматура А500
- Вывоз строительного мусора

РЕАКЦИЯ СИСТЕМЫ:
Автоматически группирует в блоки:

Блок 1: "Железобетонные конструкции"
├─ Бетон C30/37 укладка (50 м3)
├─ Опалубка деревянная (200 м2)
└─ Арматура А500 (10 т)

Блок 2: "Вывоз отходов"
└─ Вывоз строительного мусора

ФРОНТЕНД:
- Две вкладки для каждого блока
- Может развернуть каждый блок для деталей
- Показывает количество позиций в блоке
```

---

### Сценарий 4: Пользователь вводит контекст проекта (опционально)

```
ДЕЙСТВИЕ ПОЛЬЗОВАТЕЛЯ:
→ На экране анализа видит кнопку "🔧 Редактировать контекст"
→ Нажимает её
→ Откроется форма с полями:
   • Тип здания: [Жилой дом▼]
   • Количество этажей: [5]
   • Главные конструкции: [✓ Железобетон] [✓ Кирпич]
   • Основные системы: [✓ Каркас] [✓ Плиты]
   • Примечания: [Требуется анализ грунтов]

ИЛИ вводит JSON вручную:
{
  "building_type": "bytový dům",
  "storeys": 5,
  "main_system": ["železobeton", "cihla"],
  "foundation_concrete": "C30/37"
}

РЕАКЦИЯ СИСТЕМЫ:
✅ Сохраняет контекст в памяти
✅ Использует для более точного анализа
✅ Показывает сообщение "✓ Контекст сохранен"

ФРОНТЕНД:
- Модальное окно с формой
- JSON редактор с подсветкой синтаксиса
- Кнопки "Сохранить" и "Отмена"
```

---

## 🤖 Фаза 3: Многоролевой AI Анализ

### Сценарий 5: Система анализирует блок с помощью AI

```
ДЕЙСТВИЕ ПОЛЬЗОВАТЕЛЯ:
→ Нажимает "Analyzovat bloky" на экране
→ Система начинает обработку

РЕАКЦИЯ СИСТЕМЫ (этапы выполнения):

┌─────────────────────────────────────────────────────────┐
│ Анализ: Железобетонные конструкции                      │
├─────────────────────────────────────────────────────────┤
│ ✓ Классификация сложности: СЛОЖНАЯ                     │
│ ⏳ Запрос к структурному инженеру...                    │
│ ✓ Расчет нагрузок завершен                             │
│ ⏳ Запрос к специалисту по бетону...                    │
│ ✓ Спецификация материала завершена                      │
│ ⏳ Проверка стандартов...                               │
│ ✓ Все стандарты соответствуют                          │
│                                                         │
│ Время выполнения: 2.5 сек                              │
└─────────────────────────────────────────────────────────┘

СИСТЕМА ВЫПОЛНЯЕТ:

1️⃣ Классификация сложности:
   - Подсчитывает количество строк
   - Анализирует полноту данных
   - Ищет ключевые слова (бетон, сварка, и т.д.)
   - Результат: ПРОСТАЯ / СТАНДАРТНАЯ / СЛОЖНАЯ / ТВОРЧЕСКАЯ

2️⃣ Выбор специалистов:
   СЛОЖНЫЙ блок → вызывает:
   ├─ 🏗️ Структурный инженер
   ├─ 🧪 Специалист по бетону
   ├─ 📏 Проверка стандартов
   ├─ ⚙️ Технологические правила
   └─ 💰 Оценка стоимости (опционально)

3️⃣ Вызов AI специалистов через CLAUDE:
   Каждому специалисту дается определенная ТЕМПЕРАТУРА (creativity):

   Структурный инженер (T=0.2 - детерминированный):
   - Вопрос: "Какой класс бетона требуется для нагрузок?"
   - Ответ: "C30/37 (по расчетам)"

   Специалист по бетону (T=0.3 - полу-детерминированный):
   - Вопрос: "Какой цемент использовать?"
   - Ответ: "CEM II/B-S 42.5 R для влажных условий"

   Проверяющий стандарты (T=0.1 - очень детерминированный):
   - Вопрос: "Соответствует ли это ČSN?"
   - Ответ: "ДА, соответствует ČSN 73 1201"

4️⃣ Обнаружение конфликтов:
   ❌ КОНФЛИКТ ОБНАРУЖЕН:
   • Структурный инженер говорит: C30/37
   • Специалист по бетону говорит: C35/45

   ✅ АВТОМАТИЧЕСКОЕ РАЗРЕШЕНИЕ:
   • Применяется правило: "Более высокий требуемый класс побеждает"
   • Результат: C35/45
   • Объяснение: "Оба требования должны быть удовлетворены"

ФРОНТЕНД: ЭКРАН РЕЗУЛЬТАТОВ
┌────────────────────────────────────────────────────────┐
│ 📊 Результаты анализа: Железобетонные конструкции     │
├────────────────────────────────────────────────────────┤
│                                                         │
│ 🟠 СЛОЖНОСТЬ: Сложная (15 позиций, 87% полнота)      │
│                                                         │
│ 👥 ВОВЛЕЧЕННЫЕ СПЕЦИАЛИСТЫ:                           │
│ ┌──────────────────────────────────────────────────┐  │
│ │ 🏗️ Структурный инженер  │ ✅ Завершено        │  │
│ │ 🧪 Специалист по бетону │ ✅ Завершено        │  │
│ │ 📏 Проверка стандартов  │ ✅ Завершено        │  │
│ │ ⚙️ Технологические пр.  │ ✅ Завершено        │  │
│ └──────────────────────────────────────────────────┘  │
│                                                         │
│ ⚠️ КОНФЛИКТЫ (1):                                      │
│ ┌──────────────────────────────────────────────────┐  │
│ │ 🟠 ВЫСОКИЙ ПРИОРИТЕТ: Класс бетона             │  │
│ │                                                  │  │
│ │ Структурный инженер: C30/37                    │  │
│ │ Специалист по бетону: C35/45                   │  │
│ │                                                  │  │
│ │ 🎯 Автоматическое решение: C35/45              │  │
│ │                                                  │  │
│ │ Объяснение: Оба требования должны быть         │  │
│ │ удовлетворены. Более высокий класс выбран.     │  │
│ │                                                  │  │
│ │ [✓ Принять] [✎ Изменить] [✗ Отклонить]       │  │
│ └──────────────────────────────────────────────────┘  │
│                                                         │
│ 📋 ПОЛНЫЙ АНАЛИЗ:                                      │
│ {                                                       │
│   "complexity": "COMPLEX",                             │
│   "structural_analysis": {                            │
│     "loads": {"dead": 500, "live": 250},             │
│     "concrete_class": "C35/45",                       │
│     "warnings": ["Высокие нагрузки"]                │
│   },                                                   │
│   "material_spec": {...},                             │
│   "standards": {...},                                 │
│   "execution_time_ms": 2540                          │
│ }                                                      │
│                                                         │
│ 📜 ЖУРНАЛ АУДИТА (4 события):                         │
│ 2025-12-03 10:15:42 - ✓ Классификация: СЛОЖНАЯ      │
│ 2025-12-03 10:15:43 - ✓ Структурный инженер готов   │
│ 2025-12-03 10:15:44 - ✓ Специалист по бетону готов  │
│ 2025-12-03 10:15:45 - ✓ Анализ завершен             │
│                                                         │
│ [⬅️ Назад] [💾 Скачать] [📋 Копировать] [✉️ Отправить]│
└────────────────────────────────────────────────────────┘
```

---

## 📄 Фаза 2: Загрузка документов

### Сценарий 6: Пользователь загружает документы проекта

```
ДЕЙСТВИЕ ПОЛЬЗОВАТЕЛЯ:
→ Нажимает кнопку "📄 Наhrát Dokumenty"
→ Откроется экран с drag-and-drop зоной

ФРОНТЕНД: ЭКРАН ЗАГРУЗКИ ДОКУМЕНТОВ
┌─────────────────────────────────────────────────────┐
│ 📄 Nahrání Dokumentů                                │
├─────────────────────────────────────────────────────┤
│                                                     │
│  ┌─────────────────────────────────────────────┐  │
│  │                                             │  │
│  │          📁 Přetáhněte soubory zde         │  │
│  │      nebo klikněte pro výběr               │  │
│  │                                             │  │
│  │  Podporované: PDF, DOCX, XLSX, DWG, JPG  │  │
│  └─────────────────────────────────────────────┘  │
│                                                     │
│  NAHRANÉ DOKUMENTY:                                │
│  ┌──────────────────────────────────────────────┐ │
│  │ 📕 TechSpec.pdf       1.5 MB    [✕ Smazat] │ │
│  │ 📊 Materials.xlsx     0.8 MB    [✕ Smazat] │ │
│  │ 🏗️ Drawings.dwg       3.2 MB    [✕ Smazat] │ │
│  └──────────────────────────────────────────────┘ │
│                                                     │
│  [⬛ Nahrát a Analyzovat]  [Vymazat Všechny]      │
│  ⏳ Nahrávání: 67%                                 │
│  ████████░░░░░░░░░░░░ Nahrávání: 67%             │
│                                                     │
└─────────────────────────────────────────────────────┘

ДЕЙСТВИЕ ПОЛЬЗОВАТЕЛЯ:
→ Перетаскивает файлы в зону (или выбирает через диалог)
→ Система показывает список загруженных файлов
→ Каждый файл может быть удален перед отправкой
→ Нажимает "Nahrát a Analyzovat"

РЕАКЦИЯ СИСТЕМЫ:

1️⃣ ЗАГРУЗКА И ВАЛИДАЦИЯ:
   ✅ TechSpec.pdf - загружен
      - Проверка типа файла (magic bytes)
      - Размер: 1.5 MB < 50 MB (OK)
      - Тип: PDF ✓

   ✅ Materials.xlsx - загружен
      - Проверка типа файла
      - Размер: 0.8 MB ✓
      - Тип: XLSX ✓

   ✅ Drawings.dwg - загружен
      - Все проверки пройдены
      - Всего 3 файла загружено

2️⃣ ВАЛИДАЦИЯ ДОКУМЕНТОВ (Document Validator Service):

   ПРОВЕРКА 1: Какие типы документов загружены?
   ✓ Техническое задание (TechSpec.pdf)
   ✓ Спецификация материалов (Materials.xlsx)
   ✓ Чертежи (Drawings.dwg)
   ✗ Геологический отчет (НЕ ЗАГРУЖЕН)

   ПРОВЕРКА 2: Контекст проекта
   ✓ Тип здания: "жилой дом" (найден в TechSpec)
   ✓ Количество этажей: "5" (найден в TechSpec)
   ✓ Основная система: "железобетон" (найден в чертежах)
   ✗ Класс фундамента: НЕ НАЙДЕН - требуется RFI

   ПРОВЕРКА 3: Полнота оценка
   Документы: 3/4 = 75%
   Контекст: 3/4 = 75%
   ОБЩАЯ ПОЛНОТА: 75% ⚠️ ВНИМАНИЕ

3️⃣ ОБНАРУЖЕНИЕ RFI (Request For Information):

   🔴 КРИТИЧЕСКИЕ ВОПРОСЫ (требуют ответов):
   ├─ Какой класс бетона для фундамента?
   └─ Требуется ли геологический отчет для этого проекта?

   🟡 ВАЖНЫЕ ВОПРОСЫ:
   ├─ Какой тип грунта на участке?
   └─ Какие нормы применяются?

   💡 РЕКОМЕНДАЦИИ:
   ├─ Загрузите геологический отчет для лучшего анализа
   └─ Уточните класс бетона в техническом задании

4️⃣ ПРОВЕРКА ОТСУТСТВУЮЩИХ ДОКУМЕНТОВ:

   ❌ Отсутствует:
   • Геологический отчет (высокий приоритет)
   • Применяемые стандарты (средний приоритет)

ФРОНТЕНД: ЭКРАН РЕЗУЛЬТАТОВ ВАЛИДАЦИИ
┌──────────────────────────────────────────────────┐
│ ✓ Результаты проверки документов                │
├──────────────────────────────────────────────────┤
│                                                  │
│ ПОЛНОТА ДОКУМЕНТАЦИИ:                            │
│ ████████████████░░░░░░░░░░░░░░░░░░░░░░░░░░   │
│ 75% полнота (можно начать анализ)               │
│                                                  │
│ ✅ ЗАГРУЖЕННЫЕ ДОКУМЕНТЫ:                        │
│ ┌──────────────────────────────────────────────┐│
│ │ 📕 TechSpec.pdf                            ││
│ │    Техническое задание: 1.5 MB             ││
│ │                                            ││
│ │ 📊 Materials.xlsx                          ││
│ │    Спецификация материалов: 0.8 MB         ││
│ │                                            ││
│ │ 🏗️ Drawings.dwg                            ││
│ │    Архитектурные чертежи: 3.2 MB          ││
│ └──────────────────────────────────────────────┘│
│                                                  │
│ ❌ ОТСУТСТВУЮЩИЕ ДОКУМЕНТЫ:                     │
│ ⚠️ Геологический отчет (ВЫСОКИЙ ПРИОРИТЕТ)    │
│    → Нужен для анализа грунтов и фундамента   │
│ ⚠️ Применяемые стандарты (СРЕДНИЙ ПРИОРИТЕТ)  │
│    → Поможет уточнить требования к материалам│
│                                                  │
│ ❓ КРИТИЧЕСКИЕ ВОПРОСЫ (RFI):                   │
│ ┌──────────────────────────────────────────────┐│
│ │ 1. Какой класс бетона для фундамента?      ││
│ │    (Не найдено в документах)                ││
│ │    💡 Совет: Проверьте раздел "Фундамент" ││
│ │         в техническом задании              ││
│ │                                            ││
│ │ 2. Какой тип грунта на участке?            ││
│ │    (Нужен геологический отчет)             ││
│ │    💡 Совет: Запросите у заказчика         ││
│ └──────────────────────────────────────────────┘│
│                                                  │
│ 💡 РЕКОМЕНДАЦИИ:                                │
│ • Загрузите геологический отчет для повышения ││
│   точности анализа фундамента                  │
│ • Уточните применяемые стандарты (ČSN/EN)     │
│                                                  │
│ [Продолжить анализ] [Загрузить ещё] [Отмена]  │
└──────────────────────────────────────────────────┘
```

---

## ⚡ Фаза 4: Оптимизация и производительность

### Сценарий 7: Система кэширует результаты для скорости

```
ПЕРВЫЙ АНАЛИЗ:
ДЕЙСТВИЕ ПОЛЬЗОВАТЕЛЯ:
→ Загружает файл с блоком "Бетонные работы"
→ Вводит контекст: "жилой дом, 5 этажей"
→ Нажимает "Анализировать"

РЕАКЦИЯ СИСТЕМЫ:
⏳ Начинается анализ...
🏗️ Структурный инженер работает... (0.5 сек)
🧪 Специалист по бетону работает... (0.8 сек)
📏 Проверка стандартов... (0.3 сек)
⚙️ Технологические правила... (0.4 сек)
✅ Анализ завершен за 2.5 СЕКУНДЫ

РЕЗУЛЬТАТ СОХРАНЕН В КЭШЕ:
Ключ кэша: block_user123_a1b2c3d4
TTL (время жизни): 7 дней

───────────────────────────────────────────────

ВТОРОЙ АНАЛИЗ (ТОТ ЖЕ БЛОК):
ДЕЙСТВИЕ ПОЛЬЗОВАТЕЛЯ:
→ Загружает тот же файл еще раз
→ Вводит точно такой же контекст
→ Нажимает "Анализировать"

РЕАКЦИЯ СИСТЕМЫ:
🎯 СИСТЕМА ПРОВЕРЯЕТ КЭША...
🎯 КЭША НАЙДЕН! (Cache HIT)
✅ Результат возвращен за 0.05 СЕКУНДЫ (в 50 РАЗ БЫСТРЕЕ!)

ФРОНТЕНД ПОКАЗЫВАЕТ:
┌─────────────────────────────────────────┐
│ 💨 Загружено из кэша (быстро!)         │
│ ⏱️ Время выполнения: 0.05 сек           │
│ (Обычно: 2.5 сек)                      │
└─────────────────────────────────────────┘

ДАННЫЕ ПОЛНОСТЬЮ ИДЕНТИЧНЫ:
• Все анализы совпадают
• Все конфликты обнаружены
• Все рекомендации показаны
```

---

### Сценарий 8: Администратор смотрит метрики производительности

```
ДЕЙСТВИЕ АДМИНИСТРАТОРА:
→ Переходит на http://localhost:3000/api/jobs/admin/metrics

РЕАКЦИЯ СИСТЕМЫ:
✅ Возвращает JSON с метриками:

{
  "timestamp": "2025-12-03T10:30:15Z",

  "cache": {
    "stats": {
      "total_entries": 45,
      "valid_entries": 42,
      "expired_entries": 3,
      "cache_size_estimate_mb": "0.04",
      "max_entries": 1000,
      "hit_rate": "78.5%"
    },
    "cleanup": {
      "last_run": "2025-12-03T10:30:00Z",
      "entries_cleaned": 3
    }
  },

  "performance": {
    "summary": {
      "requests": {
        "total": 156,
        "average_ms": 1245,
        "min_ms": 45,
        "max_ms": 5200,
        "p95_ms": 3100
      },
      "role_executions": {
        "total": 312,
        "average_ms": 650,
        "slow_executions": 8
      },
      "slow_requests": 12,
      "slow_role_executions": 8
    },

    "detailed_report": {
      "bottlenecks": [
        {
          "type": "Slow Endpoints",
          "items": [
            {"endpoint": "/block-match", "duration_ms": 5200},
            {"endpoint": "/file-upload", "duration_ms": 4800}
          ]
        },
        {
          "type": "Slow Role Executions",
          "items": [
            {"role": "structural_engineer", "duration_ms": 1200},
            {"role": "standards_checker", "duration_ms": 980}
          ]
        }
      ],

      "recommendations": [
        {
          "priority": "HIGH",
          "issue": "Slow role executions detected",
          "recommendation": "Consider parallelizing role execution"
        },
        {
          "priority": "MEDIUM",
          "issue": "Low cache hit rate could be improved",
          "recommendation": "Monitor cache key distribution"
        }
      ]
    }
  },

  "health": {
    "cache_utilization": "4.2%",
    "slow_requests_percentage": "7.7%",
    "system_status": "healthy"
  }
}

ФРОНТЕНД (ЕСЛИ БЫ БЫЛ DASHBOARD):
┌─────────────────────────────────────────────┐
│ 📊 Admin Dashboard - Производительность     │
├─────────────────────────────────────────────┤
│                                             │
│ КЭШИРОВАНИЕ:                                │
│ ┌───────────────────────────────────────┐  │
│ │ Всего записей: 45/1000               │  │
│ │ Использование: 4.2%                  │  │
│ │ Hit Rate: 78.5% (отлично!)          │  │
│ │ Последняя очистка: 5 мин назад      │  │
│ │ Очищено записей: 3                  │  │
│ └───────────────────────────────────────┘  │
│                                             │
│ ЗАПРОСЫ:                                    │
│ ┌───────────────────────────────────────┐  │
│ │ Всего: 156                           │  │
│ │ Среднее время: 1.2 сек               │  │
│ │ Медленных: 12 (7.7%)                │  │
│ │ Диапазон: 0.05сек - 5.2сек          │  │
│ │ P95: 3.1 сек                        │  │
│ └───────────────────────────────────────┘  │
│                                             │
│ УЗКИЕ МЕСТА:                                │
│ 🟠 /block-match: 5200мс (медленная!)      │
│ 🟠 /file-upload: 4800мс (медленная!)      │
│ 🟡 structural_engineer: 1200мс             │
│ 🟡 standards_checker: 980мс                │
│                                             │
│ РЕКОМЕНДАЦИИ:                               │
│ 🔧 Ускорить параллельное выполнение ролей  │
│ 🔧 Увеличить размер кэша                   │
│                                             │
│ СТАТУС: ✅ ЗДОРОВ (4.2% нагрузки)        │
│                                             │
└─────────────────────────────────────────────┘
```

---

## 🎬 ПОЛНЫЙ ПОЛЬЗОВАТЕЛЬСКИЙ СЦЕНАРИЙ (от А до Я)

### Ситуация: Строительная компания анализирует смету для дома

```
ДЕНЬ 1, 10:00 - ПОЛЬЗОВАТЕЛЬ НАЧИНАЕТ

1️⃣ Пользователь открывает систему
   → Видит стартовый экран с 3 кнопками
   → Нажимает "📄 Загрузить файл со сметой"

2️⃣ Выбирает файл BOQ.xlsx (из Project/Docs)
   Файл содержит:
   ┌────────────────────────────────────────┐
   │ Описание          │ Кол-во  │ Ед.     │
   ├────────────────────────────────────────┤
   │ Заливка бетона    │ 120     │ м3      │
   │ Опалубка          │ 500     │ м2      │
   │ Арматура         │ 30      │ т       │
   │ Кирпичная кладка │ 800     │ м2      │
   │ Кровельные работы│ 300     │ м2      │
   │ Электроинсталляц│ 1000    │ м пог   │
   │ Водоснабжение   │ 150     │ м пог   │
   └────────────────────────────────────────┘

   → Система загружает и парсит файл
   → Показывает результат: "Найдено 7 позиций в 4 блоках"

3️⃣ На экране видны 4 БЛОКА:

   Блок 1: "Бетонные работы" (3 позиции)
   ├─ Заливка бетона (120 м3)
   ├─ Опалубка (500 м2)
   └─ Арматура (30 т)

   Блок 2: "Кирпичная кладка" (1 позиция)
   └─ Кирпичная кладка (800 м2)

   Блок 3: "Кровля" (1 позиция)
   └─ Кровельные работы (300 м2)

   Блок 4: "Инженерные системы" (2 позиции)
   ├─ Электроинсталляция (1000 м пог)
   └─ Водоснабжение (150 м пог)

4️⃣ Пользователь может редактировать контекст
   → Нажимает на "Блок 1: Бетонные работы"
   → Видит кнопку "🔧 Редактировать контекст"
   → Заполняет информацию:

   Тип здания: "Жилой дом (3+1 подземный этаж)"
   Количество этажей: "4"
   Главные системы:
   ✓ Железобетон (каркас)
   ✓ Кирпич (ненесущие стены)

   Примечания: "Требуется гидроизоляция подземной части"

5️⃣ Нажимает "Анализировать блок"
   → Система начинает анализ
   → Показывает прогресс-бар

   ⏳ Загрузка контекста... ✓
   ⏳ Поиск кандидатов URS... ✓ (найдено 8 вариантов на каждую позицию)
   ⏳ LLM анализ блока... ✓
   ⏳ Запуск структурного инженера... ✓
   ⏳ Запуск специалиста по бетону... ✓
   ⏳ Проверка стандартов... ✓
   ⏳ Разрешение конфликтов... ✓

   ✅ Анализ завершен за 2.3 сек

6️⃣ РЕЗУЛЬТАТЫ АНАЛИЗА Блока 1:

   СЛОЖНОСТЬ: 🟠 СЛОЖНАЯ (12 позиций, 85% полнота)

   ВОВЛЕЧЕННЫЕ СПЕЦИАЛИСТЫ:
   ✓ 🏗️ Структурный инженер (требуемый класс: C30/37)
   ✓ 🧪 Специалист по бетону (спецификация: CEM II/B)
   ✓ 📏 Проверка стандартов (соответствует ČSN ✓)
   ✓ ⚙️ Технологические правила (расход: 385 кг/м3)

   ОБНАРУЖЕННЫЕ КОНФЛИКТЫ: 1
   ┌──────────────────────────────────────────┐
   │ 🟠 ВЫСОКИЙ ПРИОРИТЕТ                     │
   │ Класс бетона                             │
   │                                          │
   │ Структурный инженер: C30/37             │
   │ Специалист по бетону: C35/45            │
   │ РЕШЕНИЕ: C35/45 (выбирается более       │
   │ высокий класс для гарантии)             │
   │                                          │
   │ [✓ Принять] [✎ Изменить] [✗ Отклонить]│
   └──────────────────────────────────────────┘

   ЖУРНАЛ АУДИТА:
   10:05:23 - ✓ Классификация сложности: СЛОЖНАЯ
   10:05:24 - ✓ Структурный инженер завершил анализ
   10:05:25 - ✓ Специалист по бетону завершил анализ
   10:05:26 - ✓ Стандарты проверены: соответствует
   10:05:26 - ⚠️ Обнаружен конфликт: класс бетона
   10:05:26 - ✓ Конфликт разрешен (выбран C35/45)
   10:05:26 - ✓ Анализ завершен

7️⃣ Пользователь видит JSON результаты:
   {
     "analysis_type": "phase3_advanced",
     "complexity": "COMPLEX",
     "execution_time_ms": 2300,
     "structural_analysis": {
       "loads": {
         "dead_load": 2500,
         "live_load": 1500
       },
       "required_concrete_class": "C30/37",
       "exposure_class": "XC3",
       "warnings": ["Требуется гидроизоляция подземной части"]
     },
     "material_specification": {
       "concrete_class": "C35/45",
       "w_c_ratio": 0.50,
       "cement_type": "CEM II/B-S 42.5 R",
       "min_cement": 380,
       "special_admixtures": ["гидрофобизатор"]
     },
     "standards_compliance": "COMPLIANT",
     "cache_status": {
       "from_cache": false
     }
   }

8️⃣ Нажимает кнопку "💾 Скачать"
   → Система создает Excel файл с результатами
   → Файл содержит:
     • Исходные данные из BОК
     • Результаты анализа каждого специалиста
     • Обнаруженные конфликты и решения
     • Рекомендации и предупреждения
     • Журнал аудита с временными метками

9️⃣ Повторный анализ того же блока

   На ДЕНЬ 2, пользователь:
   → Загружает БОК снова
   → Вводит точно такой же контекст
   → Нажимает "Анализировать"

   СИСТЕМА:
   🎯 Проверяет кэш...
   🎯 КЭША НАЙДЕН!
   ✅ Результат за 0.05 сек (вместо 2.3 сек!)

   Экран показывает:
   "💨 Загружено из кэша (быстро!)"
   "⏱️ Время: 0.05 сек (обычно 2.3 сек)"

🔟 Администратор может проверить метрики

   → Переходит на /api/jobs/admin/metrics
   → Видит:
     • Всего 156 запросов обработано
     • 78.5% попаданий в кэш
     • Средняя скорость: 1.2 сек (или 0.05 из кэша)
     • Система в отличном состоянии
```

---

## 📱 ПОЛНАЯ СТРУКТУРА ЭКРАНОВ

```
┌─ ГЛАВНЫЙ ЭКРАН (/)
│  ├─ 3 кнопки с основными действиями
│  └─ Описание каждого сценария
│
├─ ЭКРАН ЗАГРУЗКИ ФАЙЛА (/upload)
│  ├─ Выбор файла Excel
│  ├─ Показ прогресса загрузки
│  ├─ Показ найденных блоков
│  └─ Кнопка "Начать анализ"
│
├─ ЭКРАН РЕДАКТИРОВАНИЯ КОНТЕКСТА (/edit-context)
│  ├─ Форма с полями проекта
│  ├─ JSON редактор
│  └─ Кнопки сохранить/отмена
│
├─ ЭКРАН АНАЛИЗА БЛОКА (/analysis)
│  ├─ Выбор блока для анализа
│  ├─ Показ процесса анализа
│  ├─ Результаты:
│  │  ├─ Сложность блока
│  │  ├─ Выбранные специалисты
│  │  ├─ Конфликты с кнопками действий
│  │  ├─ Полный JSON результат
│  │  └─ Журнал аудита
│  └─ Кнопки: Скачать, Копировать, Отправить
│
├─ ЭКРАН ЗАГРУЗКИ ДОКУМЕНТОВ (/document-upload)
│  ├─ Drag-and-drop зона
│  ├─ Список загруженных файлов
│  ├─ Результаты валидации:
│  │  ├─ Полнота документации (%)
│  │  ├─ Загруженные документы
│  │  ├─ Отсутствующие документы
│  │  ├─ RFI (критические вопросы)
│  │  └─ Рекомендации
│  └─ Кнопка "Продолжить анализ"
│
└─ ЭКРАН АДМИНИСТРАТОРА (/admin/metrics)
   ├─ Статистика кэша
   ├─ Производительность запросов
   ├─ Медленные операции
   ├─ Рекомендации для оптимизации
   └─ Кнопки управления кэшем
```

---

## 🔄 ЖИЗНЕННЫЙ ЦИКЛ ЗАПРОСА (детальная техническая архитектура)

```
1. ПОЛЬЗОВАТЕЛЬ ОТПРАВЛЯЕТ ЗАПРОС
   POST /api/jobs/block-match
   ├─ file: BOQ.xlsx
   └─ project_context: {"building_type": "..."}

2. EXPRESS ОБРАБАТЫВАЕТ
   → performanceMonitoringMiddleware
     ├─ startRequestTimer("req_123")
     ├─ Генерирует ID запроса
     └─ Добавляет временные метки

3. JOBS ROUTER ОБРАБАТЫВАЕТ
   → parseExcelFile(file)
     └─ Парсит Excel, извлекает строки

   → groupItemsByWorkType(rows)
     └─ Группирует по TŘÍDNÍK кодам

   → ДЛЯ КАЖДОГО БЛОКА:
     a) Проверяет КЭША
        getCachedBlockAnalysis(block, context)
        ├─ КЭША НАЙДЕН? → Возвращает за 0.05 сек
        └─ КЭША НЕ НАЙДЕН? → Идет дальше

     b) Вызывает ORCHESTRATOR
        orchestrator.analyzeBlock(block, context)
        ├─ Определяет сложность
        ├─ Выбирает специалистов
        ├─ Вызывает каждого с параметрами (температура):
        │  ├─ Structural Engineer (T=0.2)
        │  ├─ Concrete Specialist (T=0.3)
        │  ├─ Standards Checker (T=0.1)
        │  ├─ Tech Rules Engine (T=0.0)
        │  └─ Cost Estimator (T=0.4)
        ├─ Обнаруживает конфликты
        └─ Разрешает конфликты

     c) recordRoleExecution(role, time)
        └─ Записывает метрики выполнения

     d) setCachedBlockAnalysis(block, context, result)
        └─ Сохраняет результат в кэш на 7 дней

     e) endRequestTimer()
        └─ Записывает общее время

4. ВОЗВРАЩАЕТ ОТВЕТ КЛИЕНТУ
   {
     "job_id": "uuid",
     "block_results": [
       {
         "phase3_advanced": {
           "complexity": "COMPLEX",
           "selected_roles": [...],
           "conflicts": [...],
           "cache_status": {
             "from_cache": false
           }
         }
       }
     ]
   }

5. ФРОНТЕНД ОТОБРАЖАЕТ РЕЗУЛЬТАТЫ
   → Парсит JSON
   → Отображает каждый компонент
   → Показывает значки действий для конфликтов

6. SCHEDULER ОЧИЩАЕТ КЭША
   Каждый час:
   → cleanExpiredEntries()
     ├─ Удаляет записи старше TTL
     ├─ Логирует удаленные записи
     └─ Проверяет здоровье кэша

7. АДМИНИСТРАТОР МОЖЕТ ПОСМОТРЕТЬ МЕТРИКИ
   GET /api/jobs/admin/metrics
   → getPerformanceSummary()
   → getDetailedPerformanceReport()
   → getCacheStats()
   → Возвращает полный отчет
```

---

## 🎨 КОМПОНЕНТЫ ФРОНТЕНДА

```html
HTML СТРУКТУРА:

<div id="app">
  <!-- Главный экран -->
  <div id="uploadSection">
    <button id="uploadFileBtn">📄 Загрузить файл</button>
    <button id="uploadDocBtn">📋 Загрузить документы</button>
    <button id="textInputBtn">✏️ Ввести текст</button>
  </div>

  <!-- Экран документов -->
  <div id="docUploadSection">
    <div id="dropZone">Drag & Drop зона</div>
    <div id="uploadedFiles">Список файлов</div>
    <button id="uploadBtn">Загрузить</button>
  </div>

  <!-- Результаты анализа -->
  <div id="resultsSection">
    <div id="complexitySection">Сложность</div>
    <div id="rolesSection">Специалисты</div>
    <div id="conflictSection">Конфликты с кнопками</div>
    <div id="analysisSection">JSON результаты</div>
    <div id="auditSection">Журнал аудита</div>
  </div>

  <!-- Phase 3 результаты -->
  <div id="phase3ResultsSection">
    <!-- То же самое, но специально для Phase 3 -->
  </div>
</div>

CSS КЛАССЫ:

.complexity-card - Сложность с эмодзи
.role-card - Карточка специалиста
.conflict-item - Элемент конфликта
.conflict-critical/high/medium/low - Цветные варианты
.conflict-actions - Кнопки действий
.conflict-btn - Кнопка (принять/изменить/отклонить)
.progress-bar - Полоса прогресса
.info-panel - Информационная панель

JAVASCRIPT ФУНКЦИИ:

loadDocumentUploadComponent() - Загружает компонент
attachDocumentUploadHandlers() - Подключает обработчики
uploadDocuments() - Отправляет файлы
displayDocumentValidation() - Показывает результаты
displayComplexityClassification() - Сложность
displaySelectedRoles() - Специалисты
displayConflicts() - Конфликты
acceptConflictResolution() - Принять
editConflictResolution() - Изменить
rejectConflictResolution() - Отклонить
displayAuditTrail() - Журнал
```

---

## 📊 ПРИМЕРЫ ДАННЫХ В КАЖДОЙ ФАЗЕ

```
ФАЗА 1: Исходный Excel
┌──────────────────────────┐
│ Описание  │ Кол-во │ Ед. │
├──────────────────────────┤
│ Бетон     │ 50     │ м3  │
│ Опалубка  │ 200    │ м2  │
└──────────────────────────┘

ФАЗА 1.5: После парсинга
{
  "rows": [
    {"description": "Бетон", "quantity": 50, "unit": "м3"},
    {"description": "Опалубка", "quantity": 200, "unit": "м2"}
  ]
}

ФАЗА 2: После валидации документов
{
  "completeness_score": 75,
  "uploaded_documents": [...],
  "missing_documents": ["Геологический отчет"],
  "rfi_items": [
    {
      "question": "Какой класс бетона?",
      "severity": "critical"
    }
  ]
}

ФАЗА 3: После AI анализа
{
  "complexity": "COMPLEX",
  "selected_roles": ["structural_engineer", "concrete_specialist"],
  "conflicts": [
    {
      "type": "CONCRETE_CLASS_MISMATCH",
      "severity": "HIGH",
      "resolution": "C35/45"
    }
  ],
  "execution_time_ms": 2540
}

ФАЗА 4: Метрики производительности
{
  "cache": {
    "hit_rate": "78.5%",
    "total_entries": 45
  },
  "performance": {
    "average_request_time": 1245,
    "slow_requests": 12
  }
}
```

Это полное описание всей системы! Теперь понятно, как она работает от начала и до конца.
