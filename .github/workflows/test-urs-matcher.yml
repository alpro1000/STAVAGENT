name: Test URS Matcher Service

on:
  push:
    branches: [main, develop]
    paths:
      - 'URS_MATCHER_SERVICE/backend/**'
      - '.github/workflows/test-urs-matcher.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'URS_MATCHER_SERVICE/backend/**'

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: 'URS_MATCHER_SERVICE/backend/package-lock.json'

      - name: üìö Install dependencies
        working-directory: URS_MATCHER_SERVICE/backend
        run: npm ci

      - name: üîç Run linter
        working-directory: URS_MATCHER_SERVICE/backend
        run: npm run lint
        continue-on-error: true

      - name: ‚úÖ Run tests with API keys from GitHub Secrets
        working-directory: URS_MATCHER_SERVICE/backend
        env:
          # Claude API key for LLM matching tests
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

          # LLM Configuration
          LLM_PROVIDER: claude
          LLM_MODEL: claude-sonnet-4-5-20250929
          LLM_TIMEOUT_MS: 30000

          # Server Configuration
          NODE_ENV: test
          PORT: 3001
          CORS_ORIGIN: http://localhost:3000
        run: npm test -- --coverage

      - name: üìä Upload coverage reports
        if: matrix.node-version == '20.x'
        uses: codecov/codecov-action@v3
        with:
          file: ./URS_MATCHER_SERVICE/backend/coverage/lcov.info
          flags: urs-matcher
          name: urs-matcher-coverage
        continue-on-error: true
