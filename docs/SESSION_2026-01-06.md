# Session 2026-01-06: UX Improvements + Delete Project + Security Audit

**Branch:** `claude/update-session-docs-nKEk1`
**Duration:** Full day session
**Focus:** Monolit Planner UX, Delete Project feature, Security Audit

---

## Summary

This session focused on improving Monolit Planner user experience, fixing critical bugs, adding new features, and conducting a comprehensive security audit.

---

## Commits

| Hash | Description |
|------|-------------|
| `8ee1032` | UX: Improve table input visibility + make Speed (MJ/h) editable |
| `3c26e2a` | UX: Improve table input visibility + make Speed (MJ/h) editable |
| `a53e011` | FIX: Monolit Planner - prevent imported bridges from disappearing |
| `42fe20b` | FEAT: Add delete entire project functionality with confirmation modal |
| `cbc9825` | FIX: Improve concrete quantity extraction from Excel |

---

## Key Changes

### 1. Import Disappearing Fix

**Problem:** –ü–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–∞ Excel –º–æ—Å—Ç—ã –ø–æ—è–≤–ª—è–ª–∏—Å—å –≤ sidebar –∏ —Å—Ä–∞–∑—É –∏—Å—á–µ–∑–∞–ª–∏.

**Root Cause:** Race condition –≤ Header.tsx:
- `setTimeout(2000)` –≤—ã–∑—ã–≤–∞–ª refetch bridges
- React Query –≤–æ–∑–≤—Ä–∞—â–∞–ª –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ (—É—Å—Ç–∞—Ä–µ–≤—à–∏–µ) –¥–∞–Ω–Ω—ã–µ
- –ù–æ–≤—ã–µ bridges –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–ª–∏—Å—å —Å—Ç–∞—Ä—ã–º–∏

**Solution:**
```typescript
// Header.tsx - removed automatic refetch
// ‚úÖ FIX: DON'T do automatic refetch after import!
if (import.meta.env.DEV) console.log('[Upload] Skipping refetch - data already in context');

// useBridges.ts - added protection
setBridges(prevBridges => {
  if (prevBridges.length > query.data.length) {
    console.warn('[useBridges] Ignoring stale refetch data');
    return prevBridges;
  }
  return query.data;
});

// AppContext.tsx - callback pattern support
setBridges: (bridges: Bridge[] | ((prev: Bridge[]) => Bridge[])) => void;
```

### 2. Speed (MJ/h) Field Editable

**Problem:** –ü–æ–ª–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ (MJ/h) –±—ã–ª–æ readonly, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –º–æ–≥–ª–∏ –≤–≤–µ—Å—Ç–∏ –Ω–æ—Ä–º—É –≤—Ä—É—á–Ω—É—é.

**Solution:**
```typescript
// PositionRow.tsx
const [speedInput, setSpeedInput] = useState<string>('');
const [isEditingSpeed, setIsEditingSpeed] = useState(false);

// onBlur calculates days from speed:
const laborHoursNeeded = qty / speedPerHour;
const hoursPerDay = crewSize * shiftHours;
const newDays = laborHoursNeeded / hoursPerDay;
handleFieldChange('days', Math.max(0.5, parseFloat(newDays.toFixed(1))));
```

### 3. Computed Values Instant Update

**Problem:** –ü—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø–æ–ª–µ–π –∏—Ç–æ–≥–æ–≤—ã–µ —Å—É–º–º—ã –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–∏—Å—å (–ø–æ–∫–∞–∑—ã–≤–∞–ª–∏ stale server data).

**Solution:** –õ–æ–∫–∞–ª—å–Ω–æ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ –≤—Å–µ—Ö derived values:
```typescript
// Compute locally from editedFields, not from stale position.*
const computedLaborHours = crewSize * shiftHours * days;
const computedCostCzk = computedLaborHours * wageCzkPh;
const computedUnitCostOnM3 = concreteM3 > 0 ? computedCostCzk / concreteM3 : 0;
const computedKrosUnitCzk = Math.ceil(computedUnitCostOnM3 / 50) * 50;
const computedKrosTotalCzk = computedKrosUnitCzk * concreteM3;
```

### 4. UX: Font/Row Optimization

**Problem:** –ü–æ—Å–ª–µ —É–≤–µ–ª–∏—á–µ–Ω–∏—è —à—Ä–∏—Ñ—Ç–∞ –¥–æ 15px –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∫–∞–∑–∞–ª "—Å—Ç–∞–ª–æ —Ö—É–∂–µ –≤–∏–¥–Ω–æ".

**Solution:**
```css
/* components.css */
.positions-table input {
  font-size: 13px;    /* was 15px - too big */
  font-weight: 500;   /* was 600 */
  height: 32px;       /* was 36px */
}

.positions-table td {
  height: 38px;       /* was 44px */
}
```

### 5. Delete Entire Project Feature

**New Feature:** –ö–Ω–æ–ø–∫–∞ üóëÔ∏è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ —Å—Ä–∞–∑—É.

**Backend:**
```javascript
// DELETE /api/monolith-projects/by-project-name/:projectName
router.delete('/by-project-name/:projectName', async (req, res) => {
  const projectName = decodeURIComponent(req.params.projectName);

  // Delete from monolith_projects (CASCADE deletes positions)
  await db.prepare('DELETE FROM monolith_projects WHERE project_name = ?').run(projectName);

  // Also delete from bridges (FK compatibility)
  await db.prepare('DELETE FROM bridges WHERE project_name = ?').run(projectName);

  res.json({ deleted_count, deleted_ids });
});
```

**Frontend:**
- `DeleteProjectModal.tsx` - –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º
- `Sidebar.tsx` - –∫–Ω–æ–ø–∫–∞ üóëÔ∏è –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ –ø—Ä–æ–µ–∫—Ç–∞
- `useBridges.ts` - `deleteProject()` mutation

### 6. Concrete Quantity Extraction Fix

**Problem:** Excel import –∏–∑–≤–ª–µ–∫–∞–ª –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–µ—Ç–æ–Ω–∞ (—Ü–µ–Ω—ã –≤–º–µ—Å—Ç–æ –æ–±—ä—ë–º–æ–≤).

**Root Causes:**
- Scoring system —Å–ª–∏—à–∫–æ–º —à—Ç—Ä–∞—Ñ–æ–≤–∞–ª —Ü–µ–ª—ã–µ —á–∏—Å–ª–∞ (-30 + -40 = -70)
- –ü–æ–∑–∏—Ü–∏—è –∫–æ–ª–æ–Ω–∫–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ M3 –Ω–µ —É—á–∏—Ç—ã–≤–∞–ª–∞—Å—å
- Price detection –±—ã–ª —Å–ª–∏—à–∫–æ–º –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–º

**Solution:**
```javascript
// concreteExtractor.js

// Strategy 1.5: Check column BEFORE M3
// Typical Excel: | Mno≈æstv√≠ | MJ | J.cena |
//                |   7.838  | M3 |  3500  |
if (m3ColIdx > 0) {
  const prevColKey = columnKeys[m3ColIdx - 1];
  const prevEntry = numbersInRow.find(item => item.key === prevColKey);
  if (prevEntry && prevEntry.num > 0) {
    qty = prevEntry.num;
  }
}

// Position scoring: +60 for adjacent to M3
if (distance === 1) score += 60;

// Reduced integer penalty: -30 ‚Üí -10
if (Number.isInteger(item.num)) score -= 10;

// Stricter price detection: >= 500 AND % 100 === 0
const isLikelyPrice = num >= 500 && num % 100 === 0;
```

---

## Security Audit Results

### ‚úÖ Protected

| Category | Implementation |
|----------|----------------|
| SQL Injection | `ALLOWED_UPDATE_FIELDS` whitelist + parameterized queries |
| Path Traversal | Check for `..` and `/` in filename (exporter.js) |
| File Upload | Extension whitelist + MIME type validation |
| Rate Limiting | 100 req/15min (API), 10 uploads/hour |
| Security Headers | Helmet middleware enabled |
| CORS | Whitelist origins with credentials |
| Debug Routes | Disabled in production (`NODE_ENV !== 'production'`) |

### ‚ö†Ô∏è Recommendations

1. **Add status validation in PUT /api/monolith-projects/:id:**
```javascript
const VALID_STATUSES = ['active', 'completed', 'archived'];
if (status && !VALID_STATUSES.includes(status)) {
  return res.status(400).json({ error: 'Invalid status' });
}
```

2. **Add input sanitization for project_name:**
```javascript
const projectName = decodeURIComponent(req.params.projectName)
  .replace(/[<>\"'`;]/g, '');
```

**Overall Score:** 8/10

---

## Files Modified

| File | Lines Changed | Description |
|------|---------------|-------------|
| `PositionRow.tsx` | +50 | Speed editing + local computed values |
| `Header.tsx` | +5 | Remove auto-refetch after import |
| `useBridges.ts` | +25 | Stale data protection + deleteProject |
| `AppContext.tsx` | +3 | Callback pattern for setBridges |
| `components.css` | +20 | Font/row size optimization |
| `Sidebar.tsx` | +40 | Delete project button + modal |
| `DeleteProjectModal.tsx` | +80 (NEW) | Confirmation modal component |
| `api.ts` | +5 | deleteByProjectName method |
| `monolith-projects.js` | +45 | DELETE by-project-name endpoint |
| `concreteExtractor.js` | +50 | Improved quantity detection |

**Total:** ~320 lines changed/added

---

## Next Steps

1. **Priority 1:** Connect optimized Multi-Role to Portal UI (SSE streaming)
2. **Priority 2:** Production testing (Workflow C, delete project)
3. **Priority 3:** Summary Module implementation

---

**Session End:** 2026-01-06
