# StavAgent Service Contract

**API Contracts, Data Formats, and Integration Patterns**

---

## Overview

This document defines how the three core services communicate with each other. It covers:
- API endpoints and their contracts
- Data formats and IDs
- Main integration flows
- Error handling and retry strategies
- Future extensibility for new kiosks

---

## Service Roles Recap

| Service | Role | API Type | Port (Dev) |
|---------|------|----------|-----------|
| **concrete-agent** | Core backend, parsers, AI, audit | FastAPI REST | 8000 |
| **stavagent-portal** | Portal, auth, project management, kiosk routing | Express REST | 3001 |
| **Monolit-Planner** | Kiosk calculator for monolithic concrete | Express REST | 3002 |

---

## ID Concepts and Naming

### Project IDs

**Portal Project ID** (`project_id`):
- Format: UUID (v4)
- Scope: Portal database
- Example: `550e8400-e29b-41d4-a716-446655440000`
- Used by: Portal, portal users
- Represents: A user's construction project in the portal

**Core Processing ID** (`processing_id`):
- Format: UUID (v4) or string identifier
- Scope: concrete-agent internal state
- Example: `core_proc_550e8400-e29b-41d4-a716-446655440000`
- Generated by: concrete-agent on upload
- Used by: Core service, kiosks (via portal)
- Represents: A document/data processing session in concrete-agent

**Mapping**:
```
Portal stores:
  project_id → { ..., core_processing_id, kiosk_results: {...} }

When portal calls concrete-agent:
  POST /upload { project_id, files[] }
  ← Response includes: processing_id

Portal stores: { project_id: xxx, core_processing_id: yyy }
```

### Kiosk Result IDs

Each kiosk generates its own result identifiers:

**Monolit-Planner**:
- `kioskResultId` (UUID): Identifies calculation results for a project
- Example: `monolit_550e8400-e29b-41d4-a716-446655440000`
- Portal references this to retrieve results

---

## Portal ↔ concrete-agent Contract

### Endpoint: Upload and Parse

**Request**:
```http
POST http://concrete-agent:8000/workflow/a/import
Content-Type: multipart/form-data

Form Data:
  - files: [file1.pdf, file2.xlsx, ...]
  - project_id: "550e8400-e29b-41d4-a716-446655440000" (optional, for tracking)
  - options: { kros_matching: true, enrich: true }
```

**Response** (200 OK):
```json
{
  "processing_id": "core_proc_550e8400-e29b-41d4-a716-446655440000",
  "project_id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "processing",
  "parsed_positions": [
    {
      "id": "pos_1",
      "description": "Betona̟ní základů",
      "quantity": 43.8,
      "unit": "m³",
      "confidence": 0.95,
      "otskp_code": "301 211",
      "source_row": 5
    }
  ],
  "metadata": {
    "files_processed": 1,
    "total_positions": 12,
    "parsing_time_ms": 2341
  }
}
```

**Error Response** (400/500):
```json
{
  "error": "parsing_failed",
  "message": "Could not parse any files",
  "details": {
    "files_attempted": 1,
    "files_failed": 1,
    "reason": "Unsupported file format"
  }
}
```

---

### Endpoint: Get Processing Status

**Request**:
```http
GET http://concrete-agent:8000/workflow/a/status/{processing_id}
```

**Response** (200 OK):
```json
{
  "processing_id": "core_proc_550e8400-e29b-41d4-a716-446655440000",
  "status": "completed",
  "parsed_positions": [...],
  "audit_results": [
    {
      "position_id": "pos_1",
      "role": "sme",
      "classification": "green",
      "score": 0.95,
      "comment": "Valid KROS code"
    },
    {
      "position_id": "pos_1",
      "role": "architect",
      "classification": "green",
      "score": 0.92,
      "comment": "Matches specification"
    }
  ],
  "overall_classification": "green"
}
```

---

### Endpoint: Analyze Drawing (Workflow B)

**Request**:
```http
POST http://concrete-agent:8000/workflow/b/analyze_drawing
Content-Type: multipart/form-data

Form Data:
  - drawing_file: file.pdf
  - drawing_type: "floor_plan" | "section" | "detail"
  - project_context: { ... } (optional)
```

**Response** (200 OK):
```json
{
  "drawing_id": "draw_550e8400-e29b-41d4-a716-446655440000",
  "analysis": {
    "structure_type": "monolith",
    "concrete_volume_estimated": 45.2,
    "confidence": 0.87,
    "structural_elements": [
      {
        "element": "foundation",
        "quantity": 10,
        "unit": "m³"
      }
    ]
  },
  "suggested_positions": [
    {
      "description": "Betonování základové desky",
      "quantity": 10,
      "unit": "m³",
      "otskp_code": "301 211"
    }
  ]
}
```

---

## Portal ↔ Kiosk Contract

### Kiosk Registration (Future)

**Discovery Mechanism** (TODO - to be implemented):
- Option A: Portal reads kiosk registry from config file
- Option B: Kiosks register themselves with portal on startup via HTTP
- Option C: Portal discovers kiosks via environment variables

**Current Implementation**: Hardcoded in portal config

---

### Endpoint: Send Project to Kiosk

**Request**:
```http
POST http://monolit-planner:3002/import
Content-Type: application/json

{
  "projectId": "550e8400-e29b-41d4-a716-446655440000",
  "projectName": "Bridge SO201",
  "projectType": "monolith",
  "positions": [
    {
      "id": "pos_1",
      "description": "Betona̟ní základů",
      "quantity": 43.8,
      "unit": "m³",
      "otskpCode": "301 211"
    }
  ],
  "metadata": {
    "sourceWorkflow": "core_audit",
    "processingId": "core_proc_550e8400-e29b-41d4-a716-446655440000"
  }
}
```

**Response** (200 OK):
```json
{
  "kioskResultId": "monolit_550e8400-e29b-41d4-a716-446655440000",
  "status": "imported",
  "message": "Project imported successfully",
  "importedPositions": 12
}
```

---

### Endpoint: Get Kiosk Status

**Request**:
```http
GET http://monolit-planner:3002/status/{kioskResultId}
```

**Response** (200 OK):
```json
{
  "kioskResultId": "monolit_550e8400-e29b-41d4-a716-446655440000",
  "projectId": "550e8400-e29b-41d4-a716-446655440000",
  "status": "completed",
  "progress": 100,
  "positionsCalculated": 12,
  "summary": {
    "totalCost": 2500000,
    "unitCost": 1250,
    "estimatedDuration": 6.5,
    "durationUnit": "months"
  }
}
```

---

### Endpoint: Get Kiosk Results

**Request**:
```http
GET http://monolit-planner:3002/results/{kioskResultId}
```

**Response** (200 OK):
```json
{
  "kioskResultId": "monolit_550e8400-e29b-41d4-a716-446655440000",
  "projectId": "550e8400-e29b-41d4-a716-446655440000",
  "positions": [
    {
      "id": "pos_1",
      "description": "Betona̟ní základů",
      "quantity": 43.8,
      "unit": "m³",
      "laborHours": 3744,
      "laborCost": 187200,
      "unitCostCzk": 4274,
      "krosUnit": 4300,
      "krosTotal": 188340,
      "crew": 8,
      "wage": 50,
      "shiftHours": 8,
      "days": 12
    }
  ],
  "summary": {
    "totalCost": 2500000,
    "unitCost": 1250,
    "estimatedDuration": 6.5,
    "durationUnit": "months",
    "workMode": "30_days_per_month"
  }
}
```

---

### Endpoint: Export Results

**Request**:
```http
GET http://monolit-planner:3002/export/{kioskResultId}?format=xlsx
```

**Response** (200 OK):
```
Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
Content-Disposition: attachment; filename="project_550e8400.xlsx"

[Excel file with formulas and formatting]
```

---

## Main Integration Flows

### Flow 1: Complete Upload → Audit → Kiosk Path

```
┌─────────────────┐
│  Portal: User   │
│  uploads file   │
└────────┬────────┘
         │
         ▼
┌─────────────────────────────────────────────────────┐
│ Portal: POST /api/portal-projects/uploadFile         │
│   (stores file locally)                             │
└────────┬────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────┐
│ Portal: POST concrete-agent/workflow/a/import        │
│   (send file to CORE for parsing)                   │
└────────┬────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────┐
│ concrete-agent:                                     │
│   - Parse file                                      │
│   - Extract positions                               │
│   - Match to KROS codes                             │
│   - Multi-role audit                                │
│   - Return processing_id + results                  │
└────────┬────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────┐
│ Portal: Display audit results                        │
│   - GREEN: Ready to use                             │
│   - AMBER: Review needed                            │
│   - RED: Needs correction                           │
└────────┬────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────┐
│ Portal: User selects kiosk (e.g., "Monolit")         │
│   (Portal stores: project_id → kiosk_type)          │
└────────┬────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────┐
│ Portal: POST monolit-planner/import                  │
│   (send project + positions)                        │
└────────┬────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────┐
│ Monolit-Planner:                                    │
│   - Import positions                                │
│   - Calculate costs                                 │
│   - Generate results                                │
└────────┬────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────┐
│ Portal: GET monolit-planner/results/{kioskResultId}  │
│   (retrieve calculated results)                     │
└────────┬────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────┐
│ Portal: Display results                              │
│   - Show calculations                               │
│   - Allow export                                    │
└─────────────────────────────────────────────────────┘
```

---

### Flow 2: Drawing Analysis

```
Portal: User uploads drawing
         │
         ▼
Portal: POST concrete-agent/workflow/b/analyze_drawing
         │
concrete-agent:
  - GPT-4 Vision extracts structure
  - Claude calculates quantities
  - Returns suggested positions
         │
         ▼
Portal: Display suggestions
         │
Portal: User accepts → Route to Monolit
         │
         ▼
Monolit-Planner: Receives positions
         │
         ▼
Monolit-Planner: Calculates and stores results
         │
         ▼
Portal: Displays final calculations
```

---

## Standard Data Formats

### Position Object

**Complete Format** (as used across all services):

```json
{
  "id": "uuid",
  "description": "string (work item name)",
  "quantity": "number",
  "unit": "m³ | m² | kg | ks | m | etc.",
  "confidence": "number (0-1, from parser)",
  "otskpCode": "string (Czech construction code)",
  "crew": "number (workers on team)",
  "wage": "number (CZK per hour)",
  "shiftHours": "number (hours per shift)",
  "days": "number (days to complete)",
  "laborHours": "number (crew × shiftHours × days)",
  "laborCost": "number (laborHours × wage)",
  "concreteVolume": "number (m³, reference for unit cost)",
  "unitCostCzk": "number (CZK per m³ of concrete)",
  "krosUnit": "number (rounded to nearest 50)",
  "krosTotal": "number (krosUnit × quantity or concreteVolume)",
  "notes": "string (optional)"
}
```

### Project Object

**Portal Project Format**:

```json
{
  "id": "uuid",
  "name": "string",
  "type": "monolith | pump | formwork | ...",
  "description": "string",
  "ownerId": "uuid",
  "status": "draft | in_audit | in_kiosk | completed",
  "coreProcessingId": "string (from concrete-agent)",
  "kiosks": {
    "monolith": {
      "kioskResultId": "uuid",
      "status": "idle | processing | completed",
      "lastUpdated": "ISO8601"
    }
  },
  "createdAt": "ISO8601",
  "updatedAt": "ISO8601"
}
```

---

## Error Handling

### Standard Error Response Format

**All services** return errors in this format:

```json
{
  "error": "error_code",
  "message": "Human-readable message",
  "details": {
    "key": "value"
  },
  "timestamp": "ISO8601",
  "requestId": "uuid (for logging)"
}
```

### Common Error Codes

| Code | HTTP | Meaning | Retry? |
|------|------|---------|--------|
| `parsing_failed` | 400 | File format unsupported | No |
| `invalid_request` | 400 | Missing/bad request data | No |
| `service_unavailable` | 503 | Service offline | Yes (backoff) |
| `timeout` | 504 | Processing took too long | Yes |
| `database_error` | 500 | Database operation failed | Yes |
| `unauthorized` | 401 | Missing/invalid auth | No |
| `forbidden` | 403 | No permission | No |
| `not_found` | 404 | Resource not found | No |

### Retry Strategy

**Portal calling concrete-agent**:
- Immediate retries: 3 attempts with exponential backoff (1s, 2s, 4s)
- Store processing_id and poll status later
- Timeout: 60 seconds per request

**Portal calling kiosks**:
- Same as above, with longer timeout for heavy calculations (up to 300s)

---

## Future: Adding a New Kiosk

**Steps to integrate a new kiosk** (e.g., "Pump Calculator"):

1. **Create service**: New Node.js application at `/Pump-Kiosk`

2. **Implement standard endpoints**:
   ```
   POST /import         # Accept project data
   GET  /status/:id     # Get calculation progress
   GET  /results/:id    # Get final results
   POST /export/:id     # Export results
   ```

3. **Register with portal** (mechanism TBD):
   - Add to portal's kiosk registry
   - Portal discovers it via config or HTTP
   - Portal can now route projects to it

4. **Use standard data format**:
   - Accept Position objects as defined above
   - Return results in same format
   - Use OTSKP codes for compatibility

5. **Error handling**:
   - Follow standard error response format
   - Return standard error codes
   - Support retry logic

---

## Authentication & Security

### Current Implementation

**Portal ↔ concrete-agent**:
- No explicit auth (internal network assumption)
- TODO: Add API key or JWT validation

**Portal ↔ Kiosks**:
- No explicit auth (internal network assumption)
- TODO: Add API key or JWT validation

**User-facing auth**:
- Portal: JWT tokens, 24-hour expiry, refresh tokens
- Kiosks: User inherits portal session (future implementation)

### Recommendations for Production

1. Add API key authentication between services
2. Use mTLS for inter-service communication
3. Rate limiting on all public endpoints
4. Log all inter-service calls
5. Timeout on external calls (concrete-agent, kiosks)

---

## Performance & Timeouts

| Operation | Expected Duration | Max Timeout |
|-----------|-------------------|------------|
| File upload validation | 1-5s | 10s |
| Parse simple Excel | 2-10s | 30s |
| Parse complex PDF | 10-60s | 120s |
| Multi-role audit | 5-30s | 60s |
| Route to kiosk | 1-5s | 10s |
| Kiosk calculation | 1-30s | 300s |

---

## Testing the Contract

### Local Testing

**Test upload flow**:
```bash
# Terminal 1: concrete-agent
cd concrete-agent && npm run dev:backend

# Terminal 2: portal
cd stavagent-portal && npm run dev:backend

# Terminal 3: test
curl -X POST http://localhost:3001/api/upload \
  -F "file=@test.xlsx"
```

### Expected Behavior

1. Portal receives file
2. Portal forwards to concrete-agent
3. concrete-agent parses and audits
4. Portal displays results
5. User routes to kiosk
6. Kiosk calculates
7. Portal displays final results

---

## References

- See `ARCHITECTURE.md` for system overview
- See service-level docs for implementation details
- See `LOCAL_SETUP.md` for environment setup

---

**Created**: November 2025
**Last Updated**: November 2025
**Status**: Foundation document - error codes and auth mechanisms may evolve
