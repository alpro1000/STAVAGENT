#!/bin/sh
# Husky pre-push hook - Final checks before push

echo "üöÄ Running pre-push checks..."

REPO_ROOT="/home/user/STAVAGENT"

# Check branch name (should start with claude/ and end with session ID)
BRANCH=$(git branch --show-current)
echo "üìù Current branch: $BRANCH"

# POSIX-compatible pattern matching (no regex, just basic pattern)
case "$BRANCH" in
  claude/*-?????)
    echo "‚úÖ Branch name matches pattern"
    ;;
  *)
    echo "‚ö†Ô∏è  Warning: Branch name doesn't match pattern 'claude/*-xxxxx'"
    echo "   Current: $BRANCH"
    echo "   Expected: claude/feature-name-abcde"
    ;;
esac

# Run critical formula tests (same as pre-commit)
echo "üß™ Running critical formula tests..."
(cd "$REPO_ROOT/Monolit-Planner/shared" && npm test -- --run src/formulas.test.ts)
if [ $? -ne 0 ]; then
  echo "‚ùå Formula tests failed!"
  exit 1
fi

# Run backend unit tests
echo "üß™ Running backend unit tests..."
(cd "$REPO_ROOT/Monolit-Planner/backend" && npm run test:unit 2>/dev/null)
TEST_EXIT_CODE=$?

if [ $TEST_EXIT_CODE -ne 0 ]; then
  echo "‚ö†Ô∏è  Backend unit tests failed or not available"
  echo "   Continuing anyway (tests are optional for now)"
fi

echo "‚úÖ All pre-push checks passed!"
exit 0
